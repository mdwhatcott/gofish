package rules

import (
	"testing"

	"github.com/smartystreets/assertions/should"
	"github.com/smartystreets/gunit"
)

func TestGameFixture(t *testing.T) {
	gunit.Run(new(GameFixture), t)
}

type GameFixture struct {
	*gunit.Fixture

	game *Game
}

func (this *GameFixture) Setup() {
	this.game = NewGame()
}

func (this *GameFixture) TestStartingGameConditions() {
	this.So(this.game.IsOver(), should.BeFalse)
	this.So(this.game.PlayerToMove(), should.Equal, White)
	this.So(this.game.FullMoveCount(), should.Equal, 1)
	this.So(this.game.HalfMoveCount(), should.Equal, 0)
	this.So(this.game.CanCastleKingside(White), should.BeTrue)
	this.So(this.game.CanCastleKingside(Black), should.BeTrue)
	this.So(this.game.CanCastleQueenside(White), should.BeTrue)
	this.So(this.game.CanCastleQueenside(Black), should.BeTrue)
	this.So(this.game.ExportFEN(), should.Equal, startingPositionFEN)
}

func (this *GameFixture) TestGameConditionsAfterFirstPawnMove() {
	this.game.Execute(move{From: Square("a2"), To: Square("a3"), Piece: WhitePawn})

	this.So(this.game.IsOver(), should.BeFalse)
	this.So(this.game.PlayerToMove(), should.Equal, Black)
	this.So(this.game.FullMoveCount(), should.Equal, 1)
	this.So(this.game.HalfMoveCount(), should.Equal, 0) // pawn move
	this.So(this.game.ExportFEN(), should.Equal, positionAfter1A3)
}

func (this *GameFixture) TestLoadFEN() { // TODO: test many more pieces and scenarios
	const kingsOnBackRanks = "4k3/8/8/8/8/8/8/4K3 w - - 0 1"
	err := this.game.LoadFEN(kingsOnBackRanks)
	this.So(err, should.BeNil)
	this.So(this.game.ExportFEN(), should.Equal, kingsOnBackRanks)
}

func (this *GameFixture) TestLegalFirstMoves() {
	// TODO: assert that all these moves are generated by CalculateAvailableMoves from the starting position
	// depends on basic pawn movements and knight movement
	this.assertFirstMove(move{From: Square("a2"), To: Square("a3"), Piece: WhitePawn}, positionAfter1A3)
	this.assertFirstMove(move{From: Square("a2"), To: Square("a4"), Piece: WhitePawn}, positionAfter1A4)

	this.assertFirstMove(move{From: Square("b2"), To: Square("b3"), Piece: WhitePawn}, positionAfter1B3)
	this.assertFirstMove(move{From: Square("b2"), To: Square("b4"), Piece: WhitePawn}, positionAfter1B4)

	this.assertFirstMove(move{From: Square("c2"), To: Square("c3"), Piece: WhitePawn}, positionAfter1C3)
	this.assertFirstMove(move{From: Square("c2"), To: Square("c4"), Piece: WhitePawn}, positionAfter1C4)

	this.assertFirstMove(move{From: Square("d2"), To: Square("d3"), Piece: WhitePawn}, positionAfter1D3)
	this.assertFirstMove(move{From: Square("d2"), To: Square("d4"), Piece: WhitePawn}, positionAfter1D4)

	this.assertFirstMove(move{From: Square("e2"), To: Square("e3"), Piece: WhitePawn}, positionAfter1E3)
	this.assertFirstMove(move{From: Square("e2"), To: Square("e4"), Piece: WhitePawn}, positionAfter1E4)

	this.assertFirstMove(move{From: Square("f2"), To: Square("f3"), Piece: WhitePawn}, positionAfter1F3)
	this.assertFirstMove(move{From: Square("f2"), To: Square("f4"), Piece: WhitePawn}, positionAfter1F4)

	this.assertFirstMove(move{From: Square("g2"), To: Square("g3"), Piece: WhitePawn}, positionAfter1G3)
	this.assertFirstMove(move{From: Square("g2"), To: Square("g4"), Piece: WhitePawn}, positionAfter1G4)

	this.assertFirstMove(move{From: Square("h2"), To: Square("h3"), Piece: WhitePawn}, positionAfter1H3)
	this.assertFirstMove(move{From: Square("h2"), To: Square("h4"), Piece: WhitePawn}, positionAfter1H4)
}
func (this *GameFixture) assertFirstMove(move move, expectedFEN string) {
	this.game.Reset()
	this.game.Execute(move)
	this.So(this.game.PlayerToMove(), should.Equal, Black)
	this.So(this.game.ExportFEN(), should.Equal, expectedFEN)
	this.game.TakeBack(move)
	this.So(this.game.ExportFEN(), should.Equal, startingPositionFEN)
	this.So(this.game.PlayerToMove(), should.Equal, White)
}

const positionAfter1A3 = "rnbqkbnr/pppppppp/8/8/8/P7/1PPPPPPP/RNBQKBNR b KQkq - 0 1"
const positionAfter1A4 = "rnbqkbnr/pppppppp/8/8/P7/8/1PPPPPPP/RNBQKBNR b KQkq - 0 1"
const positionAfter1B3 = "rnbqkbnr/pppppppp/8/8/8/1P6/P1PPPPPP/RNBQKBNR b KQkq - 0 1"
const positionAfter1B4 = "rnbqkbnr/pppppppp/8/8/1P6/8/P1PPPPPP/RNBQKBNR b KQkq - 0 1"
const positionAfter1C3 = "rnbqkbnr/pppppppp/8/8/8/2P5/PP1PPPPP/RNBQKBNR b KQkq - 0 1"
const positionAfter1C4 = "rnbqkbnr/pppppppp/8/8/2P5/8/PP1PPPPP/RNBQKBNR b KQkq - 0 1"
const positionAfter1D3 = "rnbqkbnr/pppppppp/8/8/8/3P4/PPP1PPPP/RNBQKBNR b KQkq - 0 1"
const positionAfter1D4 = "rnbqkbnr/pppppppp/8/8/3P4/8/PPP1PPPP/RNBQKBNR b KQkq - 0 1"
const positionAfter1E3 = "rnbqkbnr/pppppppp/8/8/8/4P3/PPPP1PPP/RNBQKBNR b KQkq - 0 1"
const positionAfter1E4 = "rnbqkbnr/pppppppp/8/8/4P3/8/PPPP1PPP/RNBQKBNR b KQkq - 0 1"
const positionAfter1F3 = "rnbqkbnr/pppppppp/8/8/8/5P2/PPPPP1PP/RNBQKBNR b KQkq - 0 1"
const positionAfter1F4 = "rnbqkbnr/pppppppp/8/8/5P2/8/PPPPP1PP/RNBQKBNR b KQkq - 0 1"
const positionAfter1G3 = "rnbqkbnr/pppppppp/8/8/8/6P1/PPPPPP1P/RNBQKBNR b KQkq - 0 1"
const positionAfter1G4 = "rnbqkbnr/pppppppp/8/8/6P1/8/PPPPPP1P/RNBQKBNR b KQkq - 0 1"
const positionAfter1H3 = "rnbqkbnr/pppppppp/8/8/8/7P/PPPPPPP1/RNBQKBNR b KQkq - 0 1"
const positionAfter1H4 = "rnbqkbnr/pppppppp/8/8/7P/8/PPPPPPP1/RNBQKBNR b KQkq - 0 1"
